<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Server Copy API - PDF with Images & QR Code</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 20px auto;
      padding: 10px;
      background: #f9f9f9;
    }
    label, input {
      display: block;
      margin: 8px 0 5px;
    }
    input[type="text"], input[type="date"] {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
    }
    button {
      margin-top: 12px;
      padding: 10px 15px;
      font-size: 16px;
      cursor: pointer;
    }
    #result {
      margin-top: 20px;
      background: #fff;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 0 5px #ccc;
    }
    img.photo {
      max-width: 150px;
      margin-top: 10px;
      border: 1px solid #ccc;
    }
    #printBtn {
      margin-top: 10px;
      display: none;
      background: #007bff;
      color: white;
      border: none;
    }
  </style>
</head>
<body>
  <h2>Server Copy API থেকে তথ্য নিন</h2>
  <form id="nidForm">
    <label for="nid">জাতীয় পরিচয়পত্র নম্বর (NID):</label>
    <input type="text" id="nid" name="nid" required placeholder="যেমন: 7355243812" />

    <label for="dob">জন্ম তারিখ (DOB):</label>
    <input type="date" id="dob" name="dob" required />

    <button type="submit">তথ্য দেখান</button>
  </form>

  <div id="result"></div>

  <button id="printBtn">PDF ডাউনলোড করুন</button>

  <!-- jsPDF লাইব্রেরি -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- jsPDF এর html2canvas প্লাগইন (ছবি ক্যাপচার জন্য) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- QRCode JS লাইব্রেরি -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>

  <script>
    const apiKey = "1e0fc13be94e217f1ec34da77f2b4e83";  // আপনার API কী
    let currentData = null;

    document.getElementById('nidForm').addEventListener('submit', function(event) {
      event.preventDefault();

      const nid = document.getElementById('nid').value.trim();
      const dob = document.getElementById('dob').value;

      if (!nid || !dob) {
        alert("দয়া করে সঠিক তথ্য দিন।");
        return;
      }

      const url = `https://unique-seba.com/api/servercopy2?api_key=${apiKey}&nid=${nid}&dob=${dob}`;

      fetch(url)
        .then(response => {
          if (!response.ok) throw new Error("API কল করতে সমস্যা হয়েছে");
          return response.json();
        })
        .then(data => {
          if(data.nameBangla) {
            currentData = data;
            displayResult(data);
            document.getElementById('printBtn').style.display = 'inline-block';
          } else {
            currentData = null;
            document.getElementById('result').innerHTML = "<p>তথ্য পাওয়া যায়নি।</p>";
            document.getElementById('printBtn').style.display = 'none';
          }
        })
        .catch(error => {
          currentData = null;
          document.getElementById('result').innerHTML = `<p style="color:red;">ত্রুটি: ${error.message}</p>`;
          document.getElementById('printBtn').style.display = 'none';
        });
    });

    function displayResult(data) {
      document.getElementById('result').innerHTML = `
        <h3>ব্যক্তির তথ্য</h3>
        <p><strong>নাম (বাংলা):</strong> ${data.nameBangla}</p>
        <p><strong>নাম (English):</strong> ${data.nameEnglish}</p>
        <p><strong>জাতীয় পরিচয়পত্র নম্বর:</strong> ${data.nationalId}</p>
        <p><strong>জন্ম তারিখ:</strong> ${data.dateOfBirth}</p>
        <p><strong>লিঙ্গ:</strong> ${data.gender}</p>
        <p><strong>ধর্ম:</strong> ${data.religion}</p>
        <p><strong>পেশা:</strong> ${data.occupation}</p>
        <p><strong>রক্তের গ্রুপ:</strong> ${data.bloodGroup}</p>
        <p><strong>পিতার নাম:</strong> ${data.fatherName}</p>
        <p><strong>মাতার নাম:</strong> ${data.motherName}</p>
        <p><strong>বর্তমান ঠিকানা:</strong> ${data.preAddress.addressLine}</p>
        <p><strong>স্থায়ী ঠিকানা:</strong> ${data.perAddress.addressLine}</p>
        <div>
          <strong>ছবি:</strong><br />
          <img class="photo" id="photoImg" src="${data.photo}" alt="ছবি" />
        </div>
        <div>
          <strong>স্বাক্ষর:</strong><br />
          <img class="photo" id="signImg" src="${data.sign}" alt="স্বাক্ষর" />
        </div>
      `;
    }

    document.getElementById('printBtn').addEventListener('click', async () => {
      if (!currentData) return alert("প্রিন্ট করার জন্য কোন তথ্য নেই।");

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      let y = 10;
      const marginLeft = 10;
      const pageWidth = doc.internal.pageSize.getWidth();

      // টেক্সট লিখা
      doc.setFontSize(16);
      doc.text("ব্যক্তির তথ্য", marginLeft, y);
      y += 10;

      doc.setFontSize(12);
      doc.text(`নাম (বাংলা): ${currentData.nameBangla}`, marginLeft, y); y += 7;
      doc.text(`নাম (English): ${currentData.nameEnglish}`, marginLeft, y); y += 7;
      doc.text(`জাতীয় পরিচয়পত্র নম্বর: ${currentData.nationalId}`, marginLeft, y); y += 7;
      doc.text(`জন্ম তারিখ: ${currentData.dateOfBirth}`, marginLeft, y); y += 7;
      doc.text(`লিঙ্গ: ${currentData.gender}`, marginLeft, y); y += 7;
      doc.text(`ধর্ম: ${currentData.religion}`, marginLeft, y); y += 7;
      doc.text(`পেশা: ${currentData.occupation}`, marginLeft, y); y += 7;
      doc.text(`রক্তের গ্রুপ: ${currentData.bloodGroup}`, marginLeft, y); y += 7;
      doc.text(`পিতার নাম: ${currentData.fatherName}`, marginLeft, y); y += 7;
      doc.text(`মাতার নাম: ${currentData.motherName}`, marginLeft, y); y += 7;
      doc.text(`বর্তমান ঠিকানা: ${currentData.preAddress.addressLine}`, marginLeft, y); y += 10;
      doc.text(`স্থায়ী ঠিকানা: ${currentData.perAddress.addressLine}`, marginLeft, y); y += 15;

      // ছবি লোড করে PDF-এ যোগ করা (Photo + Signature)
      try {
        // ছবি ফেচ করে canvas এ রূপান্তর
        const photoImg = document.getElementById('photoImg');
        const signImg = document.getElementById('signImg');

        // ছবি পজিশন ও সাইজ
        const imgWidth = 50;
        const imgHeight = 60;

        // ফটো
        const photoDataUrl = await getImageDataUrl(photoImg.src);
        doc.text("ছবি:", marginLeft, y - 10);
        doc.addImage(photoDataUrl, 'JPEG', marginLeft, y, imgWidth, imgHeight);

        // স্বাক্ষর
        const signDataUrl = await getImageDataUrl(signImg.src);
        doc.text("স্বাক্ষর:", marginLeft + imgWidth + 20, y - 10);
        doc.addImage(signDataUrl, 'PNG', marginLeft + imgWidth + 20, y, imgWidth, imgHeight);

        y += imgHeight + 15;
      } catch (e) {
        console.warn("ছবি যোগ করতে সমস্যা হয়েছে:", e);
      }

      // QR কোড তৈরি (NID + DOB এর একটা সংক্ষিপ্ত তথ্য)
      const qrText = `NID: ${currentData.nationalId}, DOB: ${currentData.dateOfBirth}`;
      const qr = qrcode(0, 'L');
      qr.addData(qrText);
      qr.make();

      // QR কোড কে base64 ইমেজে রূপান্তর
      const qrSvgTag = qr.createImgTag(6);
      // qr.createImgTag(6) returns <img src="data:image/png;base64,..." />

      // img tag থেকে src বের করা
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = qrSvgTag;
      const qrImgSrc = tempDiv.querySelector('img').src;

      // QR কোড PDF এ যোগ
      const qrSize = 50;
      doc.text("QR কোড:", marginLeft, y);
      doc.addImage(qrImgSrc, 'PNG', marginLeft, y + 5, qrSize, qrSize);

      // শেষ পর্যন্ত PDF ডাউনলোড করানো
      doc.save(`server_copy_${currentData.nationalId}.pdf`);
    });

    // ইউটিলিটি: ছবি URL থেকে DataURL (base64) নিয়ে আসবে
    function getImageDataUrl(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous"; // CORS সমস্যা এড়ানোর জন্য
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          resolve(canvas.toDataURL('image/jpeg'));
        };
        img.onerror = reject;
        img.src = url;
      });
    }
  </script>
</body>
</html>
